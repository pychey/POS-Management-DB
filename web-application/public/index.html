<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS User & Role Management</title>
</head>
<body>
    <h1>POS Management System - User & Role Administration</h1>
    
    <!-- Display All Users with Roles -->
    <div>
        <h2>Current Users and Roles</h2>
        <button onclick="loadUsers()">Refresh Users</button>
        <table border="1" id="usersTable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Host</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- Users will be loaded here -->
            </tbody>
        </table>
    </div>

    <hr>

    <!-- Create New User -->
    <div>
        <h2>Create New User</h2>
        <form onsubmit="createUser(event)">
            <label>Username: <input type="text" id="newUsername" required></label><br><br>
            <label>Password: <input type="password" id="newPassword" required></label><br><br>
            <label>Host: <input type="text" id="newHost" value="%" required></label><br><br>
            <label>Role: 
                <select id="newUserRole" required>
                    <option value="">Select Role</option>
                    <option value="database_admin">Database Admin</option>
                    <option value="senior_developer">Senior Developer</option>
                    <option value="backend_developer">Backend Developer</option>
                    <option value="frontend_developer">Frontend Developer</option>
                    <option value="data_analyst">Data Analyst</option>
                    <option value="qa_tester">QA Tester</option>
                    <option value="intern_developer">Intern Developer</option>
                    <option value="intern_analyst">Intern Analyst</option>
                </select>
            </label><br><br>
            <button type="submit">Create User</button>
        </form>
    </div>

    <hr>

    <!-- Role Management -->
    <div>
        <h2>Role Management</h2>
        <button onclick="loadRoles()">Refresh Roles</button>
        <table border="1" id="rolesTable">
            <thead>
                <tr>
                    <th>Role Name</th>
                    <th>Description</th>
                    <th>User Count</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="rolesTableBody">
                <!-- Roles will be loaded here -->
            </tbody>
        </table>

        <h3>Create New Role</h3>
        <form onsubmit="createRole(event)">
            <label>Role Name: <input type="text" id="newRoleName" required></label><br><br>
            <label>Description: <input type="text" id="newRoleDesc"></label><br><br>
            <button type="submit">Create Role</button>
        </form>
    </div>

    <hr>

    <!-- Privilege Management -->
    <div>
        <h2>Privilege Management</h2>
        
        <h3>Grant Privileges to Role</h3>
        <form onsubmit="grantPrivileges(event)">
            <label>Role: 
                <select id="privilegeRole" required>
                    <option value="">Select Role</option>
                </select>
            </label><br><br>
            
            <label>Table: 
                <select id="privilegeTable" required>
                    <option value="">Select Table</option>
                    <option value="pos_system">POS System</option>
                    <option value="pos_feature">POS Feature</option>
                    <option value="pricing">Pricing</option>
                    <option value="store_client">Store Client</option>
                    <option value="pos_sale">POS Sale</option>
                    <option value="store_inventory">Store Inventory</option>
                    <option value="store_transaction">Store Transaction</option>
                    <option value="transaction_item">Transaction Item</option>
                    <option value="blog">Blog</option>
                </select>
            </label><br><br>
            
            <label>Privileges:</label><br>
            <input type="checkbox" id="privSelect" value="SELECT"> SELECT<br>
            <input type="checkbox" id="privInsert" value="INSERT"> INSERT<br>
            <input type="checkbox" id="privUpdate" value="UPDATE"> UPDATE<br>
            <input type="checkbox" id="privDelete" value="DELETE"> DELETE<br><br>
            
            <button type="submit">Grant Privileges</button>
        </form>
        
        <h3>Current Role Privileges</h3>
        <select id="viewPrivilegesRole" onchange="viewRolePrivileges()">
            <option value="">Select Role to View Privileges</option>
        </select>
        <div id="privilegesDisplay"></div>
    </div>

    <script>
        // API base URL
        const API_BASE = '/api';

        // Data storage
        let users = [];
        let roles = [];

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                users = await response.json();
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                users.forEach(user => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.host}</td>
                        <td>${user.role}</td>
                        <td>${user.status}</td>
                        <td>
                            <button onclick="deleteUser('${user.username}', '${user.host}')">Delete</button>
                            <button onclick="editUser('${user.username}', '${user.host}')">Edit</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load users');
            }
        }

        async function createUser(event) {
            event.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const host = document.getElementById('newHost').value;
            const role = document.getElementById('newUserRole').value;
            
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password, host, role })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    document.querySelector('form').reset();
                    loadUsers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Failed to create user');
            }
        }

        async function deleteUser(username, host) {
            if (confirm(`Are you sure you want to delete user ${username}@${host}?`)) {
                try {
                    const response = await fetch(`${API_BASE}/users/${username}/${host}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message);
                        loadUsers();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Failed to delete user');
                }
            }
        }

        async function editUser(username, host) {
            const newRole = prompt(`Enter new role for ${username}:`);
            if (newRole) {
                try {
                    const response = await fetch(`${API_BASE}/users/${username}/${host}/role`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ newRole })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message);
                        loadUsers();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error updating user:', error);
                    alert('Failed to update user');
                }
            }
        }

        async function loadRoles() {
            try {
                const response = await fetch(`${API_BASE}/roles`);
                roles = await response.json();
                
                const tbody = document.getElementById('rolesTableBody');
                tbody.innerHTML = '';
                
                roles.forEach(role => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${role.name}</td>
                        <td>${role.description}</td>
                        <td>${role.userCount}</td>
                        <td>
                            <button onclick="deleteRole('${role.name}')">Delete</button>
                            <button onclick="editRole('${role.name}')">Edit</button>
                        </td>
                    `;
                });
                
                updateRoleDropdowns();
            } catch (error) {
                console.error('Error loading roles:', error);
                alert('Failed to load roles');
            }
        }

        async function createRole(event) {
            event.preventDefault();
            
            const roleName = document.getElementById('newRoleName').value;
            
            try {
                const response = await fetch(`${API_BASE}/roles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ roleName })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    event.target.reset();
                    loadRoles();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating role:', error);
                alert('Failed to create role');
            }
        }

        async function deleteRole(roleName) {
            if (confirm(`Are you sure you want to delete role ${roleName}?`)) {
                try {
                    const response = await fetch(`${API_BASE}/roles/${roleName}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message);
                        loadRoles();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error deleting role:', error);
                    alert('Failed to delete role');
                }
            }
        }

        function editRole(roleName) {
            const role = roles.find(r => r.name === roleName);
            if (role) {
                const newDesc = prompt(`Enter new description for ${roleName}:`, role.description);
                if (newDesc !== null) {
                    role.description = newDesc;
                    alert(`Role ${roleName} description updated!`);
                    loadRoles();
                }
            }
        }

        function updateRoleDropdowns() {
            const privilegeRoleSelect = document.getElementById('privilegeRole');
            const viewPrivilegesRoleSelect = document.getElementById('viewPrivilegesRole');
            
            privilegeRoleSelect.innerHTML = '<option value="">Select Role</option>';
            viewPrivilegesRoleSelect.innerHTML = '<option value="">Select Role to View Privileges</option>';
            
            roles.forEach(role => {
                privilegeRoleSelect.innerHTML += `<option value="${role.name}">${role.name}</option>`;
                viewPrivilegesRoleSelect.innerHTML += `<option value="${role.name}">${role.name}</option>`;
            });
        }

        async function grantPrivileges(event) {
            event.preventDefault();
            
            const role = document.getElementById('privilegeRole').value;
            const table = document.getElementById('privilegeTable').value;
            
            const privileges = [];
            if (document.getElementById('privSelect').checked) privileges.push('SELECT');
            if (document.getElementById('privInsert').checked) privileges.push('INSERT');
            if (document.getElementById('privUpdate').checked) privileges.push('UPDATE');
            if (document.getElementById('privDelete').checked) privileges.push('DELETE');
            
            if (privileges.length === 0) {
                alert('Please select at least one privilege!');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/privileges`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ role, table, privileges })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    event.target.reset();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error granting privileges:', error);
                alert('Failed to grant privileges');
            }
        }

        async function viewRolePrivileges() {
            const role = document.getElementById('viewPrivilegesRole').value;
            const display = document.getElementById('privilegesDisplay');
            
            if (!role) {
                display.innerHTML = '';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/privileges/${role}`);
                const privileges = await response.json();
                
                if (privileges.length === 0) {
                    display.innerHTML = '<p>No privileges found for this role.</p>';
                    return;
                }
                
                let html = '<h4>Privileges for ' + role + ':</h4><ul>';
                privileges.forEach(privilege => {
                    html += '<li>' + privilege + '</li>';
                });
                html += '</ul>';
                
                display.innerHTML = html;
            } catch (error) {
                console.error('Error fetching privileges:', error);
                display.innerHTML = '<p>Error loading privileges</p>';
            }
        }

        // Initialize the page
        window.onload = function() {
            loadUsers();
            loadRoles();
        };
    </script>
</body>
</html>